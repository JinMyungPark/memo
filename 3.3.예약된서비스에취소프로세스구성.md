예약된 서비스에 대한 취소 프로세스를 구성하면서 동시성 이슈를 해결하기 위한 방법을 제시하겠습니다. 동시성 문제는 여러 사용자가 동시에 예약 취소를 시도할 때 발생할 수 있으며, 이러한 문제를 해결하기 위해 메시지 큐(Kafka)와 Redis를 활용할 수 있습니다. Redis의 분산 락을 사용하지 않는 조건에서의 접근 방법은 다음과 같습니다.

### 1. 문제 정의
동시성 이슈는 다음과 같은 상황에서 발생할 수 있습니다:
- 다수의 사용자가 동일한 예약을 동시에 취소하려고 시도하는 경우.
- 한 사용자가 예약을 취소하는 동안, 다른 사용자가 예약 상태를 변경하려고 시도하는 경우.

이러한 상황을 관리하지 않으면 데이터 일관성이 깨질 수 있습니다.

### 2. 해결 방안
이 문제를 해결하기 위해 Kafka를 사용한 비동기 메시징과 Redis를 사용한 상태 관리 및 속도 향상 기법을 제안합니다.

#### 2.1 **Kafka를 통한 비동기 처리**
Kafka를 사용해 취소 요청을 비동기적으로 처리하여, 동시성 문제를 완화할 수 있습니다.

1. **취소 요청 큐 구성**:
   - 사용자가 예약 취소 요청을 보낼 때, 이 요청을 즉시 처리하는 대신 Kafka 토픽으로 메시지를 발행합니다. 이 토픽은 예약 ID와 취소 요청에 대한 정보를 포함합니다.
   - 이 방식은 취소 요청을 비동기적으로 처리하여, 동시성 문제를 방지할 수 있도록 도와줍니다.

2. **취소 요청 소비자**:
   - Kafka 소비자(Consumer)는 예약 취소 요청을 순차적으로 처리합니다. 이 소비자는 Kafka에서 메시지를 받아 처리하는 역할을 합니다.
   - 소비자는 예약 정보를 데이터베이스에서 읽고, 취소 가능 여부를 확인한 후 취소 처리 및 상태 업데이트를 수행합니다.

#### 2.2 **Redis를 활용한 데이터 캐싱 및 상태 관리**
Redis를 사용해 예약 상태를 관리하고, 데이터베이스 접근을 최소화하여 속도와 성능을 향상시킬 수 있습니다.

1. **예약 상태 캐싱**:
   - 예약의 상태(예: 예약됨, 취소됨 등)를 Redis에 캐싱합니다. 이렇게 하면 예약 상태 확인이 빠르게 이루어지며, 데이터베이스에 직접 접근하지 않아도 됩니다.
   - 캐시된 데이터는 TTL(Time To Live)을 설정하여 일정 시간이 지나면 자동으로 만료되도록 합니다.

2. **상태 변경 원자적 처리**:
   - 취소 요청을 처리할 때, 먼저 Redis에서 해당 예약의 상태를 확인합니다. 취소 가능 상태인 경우에만 상태를 '취소 중'으로 변경하고, 이후 실제 취소 작업을 수행합니다.
   - Redis의 `WATCH`와 `MULTI/EXEC` 기능을 활용해 상태 변경을 원자적으로 처리하여, 여러 취소 요청이 동시에 발생하더라도 한 번에 하나의 요청만 성공하도록 합니다.

3. **이중 체크 패턴 (Double-Check Pattern)**:
   - Redis에서 상태 변경을 완료한 후, 데이터베이스에 최종적으로 상태를 반영합니다. 이 과정에서 다시 한 번 상태를 확인하여 동시성 이슈가 발생하지 않도록 합니다.

#### 2.3 **프로세스 흐름**
1. **취소 요청 수신**: 사용자가 예약 취소 요청을 전송합니다.
2. **Kafka에 메시지 발행**: 취소 요청을 Kafka 토픽에 메시지로 발행합니다.
3. **Kafka 소비자 처리**: 소비자가 메시지를 읽고, Redis에서 예약 상태를 확인합니다.
4. **Redis 상태 확인 및 업데이트**: Redis에서 상태를 확인 후, 취소 가능 상태인 경우 상태를 '취소 중'으로 변경합니다.
5. **취소 처리**: 상태가 업데이트된 후, 데이터베이스에서 실제 예약 취소를 수행하고, 최종 상태를 반영합니다.
6. **결과 반환**: 처리 결과를 사용자에게 반환합니다.

### 3. 고려 사항
- **상태 일관성**: Redis에 저장된 상태와 데이터베이스에 저장된 상태 간의 일관성을 유지해야 합니다. 이를 위해 이중 체크 패턴과 같은 방법을 사용합니다.
- **장애 처리**: Kafka에서 메시지를 처리 중에 장애가 발생한 경우, 메시지가 재처리되도록 설계해야 합니다. 이를 위해 Kafka의 재시도 메커니즘을 활용할 수 있습니다.
- **확장성**: 이 구조는 수평적으로 확장 가능하므로, 예약 요청이 증가하더라도 성능 저하 없이 처리할 수 있습니다.

### 결론
이 접근 방식은 Kafka를 사용해 취소 요청을 비동기적으로 처리하고, Redis를 사용해 상태를 관리함으로써 동시성 이슈를 효과적으로 해결할 수 있습니다. Redis의 분산 락을 사용하지 않더라도, 상태 관리와 원자적 처리를 통해 데이터 일관성을 유지하면서 성능을 최적화할 수 있습니다.
